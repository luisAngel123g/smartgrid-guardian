<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartGrid Guardian ‚Äî Monitoreo Predictivo del Sistema El√©ctrico de La Guajira</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#7c3aed; --glass: rgba(255,255,255,0.04);
      --muted:#9aa4b2; --success:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --glass-2: rgba(255,255,255,0.03); --energy-blue:#06b6d4; --renewable-green:#10b981;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
    body{margin:0;background:linear-gradient(180deg,#041025 0%, #07172a 60%);color:#e6eef6;min-height:100vh;}
    .wrap{max-width:1400px;margin:0 auto;padding:20px;}
    header{display:flex;align-items:center;gap:20px;margin-bottom:25px;padding:15px 0;}
    .logo{width:70px;height:70px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--energy-blue));display:flex;align-items:center;justify-content:center;font-weight:800;color:white;box-shadow:0 8px 30px rgba(12,16,24,0.6);font-size:24px;}
    h1{margin:0;font-size:28px;font-weight:700;}
    p.lead{margin:5px 0 0;color:var(--muted);font-size:16px;}

    .grid{display:grid;grid-template-columns:1fr 400px;gap:25px;align-items:start;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:20px;border:1px solid var(--glass);box-shadow:0 10px 30px rgba(2,6,23,0.6);margin-bottom:20px;}
    .controls{display:flex;gap:12px;align-items:center;}
    button{background:var(--accent);border:none;color:white;padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.3s ease;}
    button:hover{background:#6d28d9;transform:translateY(-2px);box-shadow:0 5px 15px rgba(124,58,237,0.4);}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.1);}
    button.secondary:hover{background:rgba(255,255,255,0.05);transform:translateY(-2px);}
    .small{font-size:13px;padding:10px 15px;}

    .stats{display:flex;gap:15px;margin-top:20px;}
    .stat{flex:1;background:var(--glass-2);padding:15px;border-radius:12px;text-align:center;transition:all 0.3s ease;}
    .stat:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,0.2);}
    .stat h3{margin:0;font-size:24px;font-weight:700;}
    .stat p{margin:8px 0 0;color:var(--muted);font-size:14px;}

    .chart-wrap{height:400px;padding:15px;background:var(--glass-2);border-radius:12px;margin-top:15px;}
    canvas{max-width:100%;}

    table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px;}
    th,td{padding:12px 15px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.05);}
    th{color:var(--muted);font-weight:600;background:rgba(255,255,255,0.02);}
    tr:hover{background:rgba(255,255,255,0.02);}
    .tag{display:inline-block;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;}
    .tag.green{background:rgba(34,197,94,0.15);color:var(--success);border:1px solid rgba(34,197,94,0.3);}
    .tag.yellow{background:rgba(245,158,11,0.15);color:var(--warn);border:1px solid rgba(245,158,11,0.3);}
    .tag.red{background:rgba(239,68,68,0.15);color:var(--danger);border:1px solid rgba(239,68,68,0.3);}

    footer{margin-top:30px;color:var(--muted);font-size:14px;padding:20px 0;border-top:1px solid rgba(255,255,255,0.05);}

    /* Nuevos estilos */
    .status-indicator{display:flex;align-items:center;gap:12px;padding:15px 20px;border-radius:12px;margin-bottom:20px;font-size:16px;font-weight:600;}
    .status-indicator.green{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3)}
    .status-indicator.yellow{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3)}
    .status-indicator.red{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3)}
    .status-dot{width:14px;height:14px;border-radius:50%;}
    .status-dot.green{background:var(--success);box-shadow:0 0 10px rgba(34,197,94,0.5);}
    .status-dot.yellow{background:var(--warn);box-shadow:0 0 10px rgba(245,158,11,0.5);}
    .status-dot.red{background:var(--danger);box-shadow:0 0 10px rgba(239,68,68,0.5);}

    .alert-banner{background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);padding:15px 20px;border-radius:12px;margin-bottom:20px;display:none;font-size:15px;}
    .alert-banner.show{display:flex;align-items:center;gap:15px;animation:pulse 2s infinite;}
    .alert-icon{color:var(--danger);font-size:24px;}
    @keyframes pulse{0%{opacity:1;}50%{opacity:0.7;}100%{opacity:1;}}

    .zones-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:15px;}
    .zone-card{background:var(--glass-2);padding:15px;border-radius:12px;transition:all 0.3s ease;cursor:pointer;}
    .zone-card:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,0.2);background:rgba(255,255,255,0.03);}
    .zone-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .zone-name{font-weight:600;font-size:15px;}
    .zone-stats{display:flex;justify-content:space-between;font-size:13px;color:var(--muted);}
    .zone-bar{height:8px;background:rgba(255,255,255,0.1);border-radius:4px;margin-top:10px;overflow:hidden;}
    .zone-bar-fill{height:100%;border-radius:4px;transition:all 0.5s ease;}
    .zone-bar-fill.green{background:linear-gradient(90deg, var(--success), #4ade80);}
    .zone-bar-fill.yellow{background:linear-gradient(90deg, var(--warn), #fbbf24);}
    .zone-bar-fill.red{background:linear-gradient(90deg, var(--danger), #f87171);}

    .tgs-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:15px;}
    .tgs-item{background:var(--glass-2);padding:15px;border-radius:10px;transition:all 0.3s ease;cursor:pointer;}
    .tgs-item:hover{transform:translateY(-2px);background:rgba(255,255,255,0.03);}
    .tgs-title{font-weight:600;margin-bottom:8px;color:var(--energy-blue);font-size:14px;}
    .tgs-desc{color:var(--muted);font-size:13px;line-height:1.4;}

    .operator-panel{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:15px;}
    .op-btn{background:var(--glass-2);border:1px solid rgba(255,255,255,0.08);color:white;padding:15px;border-radius:10px;cursor:pointer;font-size:13px;text-align:center;transition:all 0.3s ease;font-weight:600;}
    .op-btn:hover{background:rgba(124,58,237,0.2);border-color:var(--accent);transform:translateY(-3px);box-shadow:0 5px 15px rgba(124,58,237,0.3);}
    .op-btn i{margin-right:8px;font-size:16px;}

    .sustainability-card{background:linear-gradient(135deg, rgba(16,185,129,0.15), rgba(6,182,212,0.15));border:1px solid rgba(16,185,129,0.3);padding:20px;border-radius:12px;margin-top:20px;transition:all 0.3s ease;}
    .sustainability-card:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(16,185,129,0.2);}
    .sustainability-title{display:flex;align-items:center;gap:12px;margin-bottom:15px;color:var(--renewable-green);font-size:18px;font-weight:600;}
    .sustainability-stats{display:flex;justify-content:space-between;font-size:14px;}
    .sustainability-value{font-weight:700;font-size:20px;color:var(--renewable-green);}

    /* Scrollbar personalizado */
    ::-webkit-scrollbar{width:8px;}
    ::-webkit-scrollbar-track{background:rgba(255,255,255,0.05);border-radius:10px;}
    ::-webkit-scrollbar-thumb{background:var(--accent);border-radius:10px;}
    ::-webkit-scrollbar-thumb:hover{background:#6d28d9;}

    /* Responsive para pantallas muy grandes */
    @media (min-width: 1600px){
      .wrap{max-width:1600px;}
      .grid{grid-template-columns:1fr 450px;}
    }

    /* Responsive para tablets */
    @media (max-width: 1024px){
      .grid{grid-template-columns:1fr;gap:20px;}
      .stats{grid-template-columns:repeat(2,1fr);}
      .zones-grid{grid-template-columns:repeat(2,1fr);}
    }

    /* Responsive para m√≥viles */
    @media (max-width: 768px){
      .wrap{padding:15px;}
      header{flex-direction:column;text-align:center;gap:15px;}
      .stats{grid-template-columns:1fr;}
      .zones-grid{grid-template-columns:1fr;}
      .operator-panel{grid-template-columns:1fr;}
      .tgs-grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"><i class="fas fa-bolt"></i></div>
      <div>
        <h1>SmartGrid Guardian ‚Äî Monitoreo Predictivo del Sistema El√©ctrico de La Guajira</h1>
        <p class="lead">Proyecto Integrador TGS ‚Ä¢ Ingenier√≠a de Sistemas ‚Ä¢ Universidad de La Guajira</p>
      </div>
    </header>

    <div id="alert-banner" class="alert-banner">
      <div class="alert-icon"><i class="fas fa-exclamation-triangle"></i></div>
      <div>
        <strong>‚ö†Ô∏è ALERTA CR√çTICA EN EL SISTEMA EL√âCTRICO</strong>
        <div style="font-size:14px;margin-top:5px">Se detectaron transformadores con riesgo elevado. Se recomienda revisi√≥n inmediata.</div>
      </div>
    </div>

    <div class="grid">
      <!-- Columna principal -->
      <div>
        <!-- Tarjeta principal de monitoreo -->
        <div class="card">
          <div id="status-indicator" class="status-indicator green">
            <div class="status-dot green"></div>
            <div><strong>ESTADO DEL SISTEMA: ESTABLE</strong></div>
          </div>
          
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <div>
              <strong style="font-size:20px;">Visor de Sensores IoT en Tiempo Real</strong>
              <div style="color:var(--muted);font-size:15px;margin-top:8px">Temperatura, Carga y Horas de uso ‚Äî Modelo predictivo de riesgo</div>
            </div>
            <div class="controls">
              <button id="btn-sim" class="small"><i class="fas fa-play"></i> Iniciar Simulaci√≥n</button>
              <button id="btn-step" class="small secondary"><i class="fas fa-step-forward"></i> Paso √önico</button>
              <button id="btn-reset" class="small secondary"><i class="fas fa-redo"></i> Reiniciar</button>
            </div>
          </div>

          <!-- Estad√≠sticas principales -->
          <div class="stats">
            <div class="stat">
              <h3 id="avg-temp">-- ¬∞C</h3>
              <p><i class="fas fa-temperature-high"></i> Temperatura Promedio</p>
            </div>
            <div class="stat">
              <h3 id="avg-load">-- %</h3>
              <p><i class="fas fa-tachometer-alt"></i> Carga Promedio</p>
            </div>
            <div class="stat">
              <h3 id="avg-risk">-- %</h3>
              <p><i class="fas fa-exclamation-triangle"></i> Riesgo Promedio</p>
            </div>
            <div class="stat">
              <h3 id="renewable-percent">-- %</h3>
              <p><i class="fas fa-leaf"></i> Energ√≠a Renovable</p>
            </div>
          </div>

          <!-- Gr√°fico principal -->
          <div class="chart-wrap">
            <canvas id="scatterChart"></canvas>
          </div>

          <!-- Tablas y distribuci√≥n -->
          <div style="display:flex;gap:20px;margin-top:20px;">
            <div style="flex:1;">
              <strong style="font-size:16px;"><i class="fas fa-list-ol"></i> Top 5 ‚Äî Transformadores Cr√≠ticos</strong>
              <table id="table-critical">
                <thead><tr><th>ID</th><th>Riesgo</th><th>Estado</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
            <div style="width:300px;">
              <strong style="font-size:16px;"><i class="fas fa-chart-pie"></i> Distribuci√≥n por Estado</strong>
              <canvas id="pieChart" style="height:200px;width:100%"></canvas>
            </div>
          </div>
        </div>

        <!-- Gr√°fico hist√≥rico -->
        <div class="card">
          <strong style="font-size:18px;"><i class="fas fa-chart-line"></i> Evoluci√≥n del Riesgo en el Tiempo</strong>
          <div class="chart-wrap" style="height:250px">
            <canvas id="historyChart"></canvas>
          </div>
        </div>

        <!-- Zonas de La Guajira -->
        <div class="card">
          <strong style="font-size:18px;"><i class="fas fa-map-marked-alt"></i> Consumo por Zonas de La Guajira</strong>
          <div class="zones-grid" id="zones-container">
            <!-- Las zonas se generar√°n con JavaScript -->
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div>
        <!-- Panel de control -->
        <div class="card">
          <strong style="font-size:18px;"><i class="fas fa-sliders-h"></i> Control de Simulaci√≥n</strong>
          
          <div style="margin-top:20px;">
            <label style="display:block;font-size:14px;margin-bottom:8px;color:var(--muted)">
              <i class="fas fa-transformer"></i> N√∫mero de transformadores: <span id="n-span" style="color:white;font-weight:600;">50</span>
            </label>
            <input id="n-range" type="range" min="10" max="200" value="50" style="width:100%;height:8px;border-radius:4px;">
          </div>

          <div style="margin-top:20px;">
            <label style="display:block;font-size:14px;margin-bottom:8px;color:var(--muted)">
              <i class="fas fa-clock"></i> Velocidad de transmisi√≥n IoT: <span id="speed-span" style="color:white;font-weight:600;">900</span> ms
            </label>
            <input id="speed-range" type="range" min="200" max="2000" value="900" style="width:100%;height:8px;border-radius:4px;">
          </div>

          <!-- Panel del operador -->
          <div style="margin-top:25px;">
            <strong style="font-size:16px;"><i class="fas fa-cogs"></i> Panel del Operador</strong>
            <div class="operator-panel">
              <div class="op-btn" id="btn-reduce-load"><i class="fas fa-minus-circle"></i> Reducir Carga</div>
              <div class="op-btn" id="btn-maintenance"><i class="fas fa-tools"></i> Mantenimiento</div>
              <div class="op-btn" id="btn-renewable"><i class="fas fa-solar-panel"></i> Energ√≠a Renovable</div>
              <div class="op-btn" id="btn-redistribute"><i class="fas fa-exchange-alt"></i> Redistribuir</div>
            </div>
          </div>

          <!-- Sostenibilidad -->
          <div class="sustainability-card">
            <div class="sustainability-title">
              <i class="fas fa-leaf"></i>
              <strong>Indicadores de Sostenibilidad</strong>
            </div>
            <div class="sustainability-stats">
              <div>
                <div style="font-size:13px;color:var(--muted)">Energ√≠a Renovable</div>
                <div class="sustainability-value" id="renewable-value">-- %</div>
              </div>
              <div>
                <div style="font-size:13px;color:var(--muted)">Emisiones Evitadas</div>
                <div class="sustainability-value" id="emissions-value">-- t CO‚ÇÇ</div>
              </div>
              <div>
                <div style="font-size:13px;color:var(--muted)">Eficiencia del Sistema</div>
                <div class="sustainability-value" id="efficiency-value">-- %</div>
              </div>
            </div>
          </div>

          <!-- Leyenda -->
          <div style="margin-top:20px;">
            <strong style="font-size:16px;"><i class="fas fa-info-circle"></i> Estados del Sistema</strong>
            <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px;">
              <div style="display:flex;align-items:center;gap:10px;"><span class="tag green">Normal</span> <span style="color:var(--muted);font-size:14px;">Riesgo < 60% - Operaci√≥n √≥ptima</span></div>
              <div style="display:flex;align-items:center;gap:10px;"><span class="tag yellow">Riesgo</span> <span style="color:var(--muted);font-size:14px;">Riesgo 60-80% - Revisi√≥n requerida</span></div>
              <div style="display:flex;align-items:center;gap:10px;"><span class="tag red">Falla Inminente</span> <span style="color:var(--muted);font-size:14px;">Riesgo ‚â• 80% - Acci√≥n inmediata</span></div>
            </div>
          </div>

          <!-- Tabla completa -->
          <div style="margin-top:20px;">
            <strong style="font-size:16px;"><i class="fas fa-table"></i> Todos los Transformadores</strong>
            <div style="max-height:300px;overflow:auto;margin-top:12px;border:1px solid rgba(255,255,255,0.05);border-radius:8px;">
              <table id="table-all">
                <thead><tr><th>ID</th><th>Temp</th><th>Carga</th><th>Horas</th><th>Riesgo</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Principios TGS -->
        <div class="card">
          <strong style="font-size:18px;"><i class="fas fa-lightbulb"></i> Principios de la Teor√≠a General de Sistemas</strong>
          <div class="tgs-grid">
            <div class="tgs-item">
              <div class="tgs-title">Entrop√≠a</div>
              <div class="tgs-desc">P√©rdida de estabilidad cuando aumenta el riesgo en el sistema el√©ctrico</div>
            </div>
            <div class="tgs-item">
              <div class="tgs-title">Negentrop√≠a</div>
              <div class="tgs-desc">Recuperaci√≥n del orden mediante mantenimiento preventivo</div>
            </div>
            <div class="tgs-item">
              <div class="tgs-title">Sinergia</div>
              <div class="tgs-desc">IA + IoT + t√©cnicos trabajan en conjunto para optimizar el sistema</div>
            </div>
            <div class="tgs-item">
              <div class="tgs-title">Homeostasis</div>
              <div class="tgs-desc">Mantiene equilibrio entre carga y temperatura del sistema</div>
            </div>
            <div class="tgs-item">
              <div class="tgs-title">Adaptabilidad</div>
              <div class="tgs-desc">El sistema se ajusta seg√∫n las condiciones del entorno</div>
            </div>
            <div class="tgs-item">
              <div class="tgs-title">Retroalimentaci√≥n</div>
              <div class="tgs-desc">Usa resultados del monitoreo para corregir y mejorar continuamente</div>
            </div>
          </div>
        </div>

        <!-- Acciones sugeridas -->
        <div class="card">
          <strong style="font-size:18px;"><i class="fas fa-tasks"></i> Acciones Sugeridas (TGS + Sostenibilidad)</strong>
          <ul style="color:var(--muted);font-size:14px;margin-top:15px;padding-left:20px;line-height:1.6;">
            <li>Monitoreo continuo y priorizaci√≥n de mantenimiento preventivo en transformadores cr√≠ticos</li>
            <li>Redistribuci√≥n inteligente de cargas en horas pico para evitar sobrecarga</li>
            <li>Instalaci√≥n de energ√≠a renovable local (solar/e√≥lica) para aliviar la red principal</li>
            <li>Plan de comunicaci√≥n proactiva con usuarios sobre horarios cr√≠ticos y consumo eficiente</li>
            <li>Implementaci√≥n de sistemas de almacenamiento energ√©tico para estabilizar la red</li>
          </ul>
        </div>
      </div>
    </div>

    <footer>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:20px;">
        <div><strong>SmartGrid Guardian</strong> ‚Äî  Proyecto Integrador TGS ‚Ä¢ Milkys √Ålvarez Guerra - Kedeiver Vera</div>
        <div style="color:var(--muted);font-size:13px;">Universidad de La Guajira ‚Ä¢ Facultad de Ingenier√≠as ‚Ä¢ 2025</div>
      </div>
    </footer>
  </div>

<script>
// ========== CONFIGURACI√ìN INICIAL ==========
console.log("üöÄ Inicializando SmartGrid Guardian para PC...");

// Datos iniciales
let N = 50;
let speed = 900;
let dataset = [];
let simInterval = null;
let historyData = [];
let renewablePercentage = 15;
let emissionsAvoided = 0;
let systemEfficiency = 85;

// Zonas de La Guajira
const zones = [
  { name: "Riohacha", consumption: 45, failures: 12, renewable: 20 },
  { name: "Maicao", consumption: 38, failures: 8, renewable: 15 },
  { name: "Uribia", consumption: 22, failures: 5, renewable: 35 },
  { name: "Manaure", consumption: 28, failures: 7, renewable: 25 },
  { name: "Albania", consumption: 18, failures: 3, renewable: 18 },
  { name: "Fonseca", consumption: 25, failures: 6, renewable: 22 }
];

// Referencias a gr√°ficos
let scatterChart = null;
let pieChart = null;
let historyChart = null;

// ========== FUNCIONES UTILITARIAS ==========
function randn(mu = 0, sigma = 1) {
  let u = 0, v = 0;
  while(u === 0) u = Math.random();
  while(v === 0) v = Math.random();
  return mu + sigma * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2 * Math.PI * v);
}

function genData(n) {
  const arr = [];
  for(let i = 0; i < n; i++) {
    const temp = Math.round(Math.max(30, Math.min(120, randn(70, 14))) * 10) / 10;
    const load = Math.round(Math.max(20, Math.min(130, randn(80, 18))) * 10) / 10;
    const hours = Math.round(Math.max(500, Math.min(12000, randn(4000, 1400))));
    const risk = Math.min(100, Math.round((0.4 * temp + 0.4 * load + 0.2 * (hours / 100)) * 10) / 10);
    let state = 'Normal';
    if(risk >= 80) state = 'Falla inminente';
    else if(risk >= 60) state = 'Riesgo';
    arr.push({id: `T${i+1}`, temp, load, hours, risk, state});
  }
  return arr;
}

// ========== FUNCIONES DE GR√ÅFICOS ==========
function buildScatter(data) {
  const ctx = document.getElementById('scatterChart').getContext('2d');
  
  const points = data.map(d => ({
    x: d.temp, 
    y: d.load, 
    r: Math.max(6, d.risk / 3), 
    id: d.id, 
    risk: d.risk, 
    state: d.state
  }));
  
  const groups = {
    Normal: points.filter(p => p.state === 'Normal'),
    Riesgo: points.filter(p => p.state === 'Riesgo'),
    'Falla inminente': points.filter(p => p.state === 'Falla inminente')
  };

  const datasets = [
    {
      label: 'Normal',
      data: groups.Normal,
      backgroundColor: 'rgba(76,175,80,0.8)',
      borderColor: '#2f7a33',
      borderWidth: 2
    },
    {
      label: 'Riesgo', 
      data: groups.Riesgo,
      backgroundColor: 'rgba(255,193,7,0.85)',
      borderColor: '#b37a00',
      borderWidth: 2
    },
    {
      label: 'Falla inminente',
      data: groups['Falla inminente'],
      backgroundColor: 'rgba(244,67,54,0.85)',
      borderColor: '#9b2b27',
      borderWidth: 2
    }
  ];

  if(scatterChart) scatterChart.destroy();

  scatterChart = new Chart(ctx, {
    type: 'bubble',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { 
            color: '#cfe8ff',
            font: { size: 14 },
            padding: 20
          }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 36, 0.9)',
          titleColor: '#e6eef6',
          bodyColor: '#cfe8ff',
          borderColor: 'rgba(124, 58, 237, 0.5)',
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              const point = context.raw;
              return [
                `Transformador: ${point.id}`,
                `Temperatura: ${point.x}¬∞C`,
                `Carga: ${point.y}%`,
                `Riesgo: ${point.risk}%`
              ];
            }
          }
        }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: 'Temperatura (¬∞C)',
            color: '#cfe8ff',
            font: { size: 14, weight: 'bold' }
          },
          ticks: { 
            color: '#d9f0ff',
            font: { size: 12 }
          },
          grid: { 
            color: 'rgba(255,255,255,0.05)',
            borderColor: 'rgba(255,255,255,0.1)'
          }
        },
        y: {
          title: {
            display: true,
            text: 'Carga (%)',
            color: '#cfe8ff',
            font: { size: 14, weight: 'bold' }
          },
          ticks: { 
            color: '#d9f0ff',
            font: { size: 12 }
          },
          grid: { 
            color: 'rgba(255,255,255,0.05)',
            borderColor: 'rgba(255,255,255,0.1)'
          }
        }
      },
      onClick: (evt, items) => {
        if(items.length > 0) {
          const item = items[0];
          const datasetIndex = item.datasetIndex;
          const index = item.index;
          const val = scatterChart.data.datasets[datasetIndex].data[index];
          
          // Crear un modal personalizado
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; align-items: center;
            justify-content: center; z-index: 1000;
          `;
          modal.innerHTML = `
            <div style="background: var(--card); padding: 30px; border-radius: 15px;
            border: 2px solid var(--accent); max-width: 400px; text-align: center;">
              <h3 style="margin-bottom: 20px; color: var(--accent);">Detalles del Transformador</h3>
              <div style="text-align: left; line-height: 1.8;">
                <div><strong>ID:</strong> ${val.id}</div>
                <div><strong>Temperatura:</strong> ${val.x}¬∞C</div>
                <div><strong>Carga:</strong> ${val.y}%</div>
                <div><strong>Riesgo:</strong> ${val.risk}%</div>
                <div><strong>Estado:</strong> <span class="tag ${val.risk < 60 ? 'green' : val.risk < 80 ? 'yellow' : 'red'}">${val.risk < 60 ? 'Normal' : val.risk < 80 ? 'Riesgo' : 'Falla inminente'}</span></div>
              </div>
              <button onclick="this.parentElement.parentElement.remove()" 
                style="margin-top: 20px; padding: 10px 20px; background: var(--accent);
                border: none; color: white; border-radius: 8px; cursor: pointer;">
                Cerrar
              </button>
            </div>
          `;
          document.body.appendChild(modal);
        }
      }
    }
  });
}

function buildPie(data) {
  const ctx = document.getElementById('pieChart').getContext('2d');
  
  const counts = { Normal: 0, Riesgo: 0, 'Falla inminente': 0 };
  data.forEach(d => counts[d.state]++);
  
  const labels = ['Normal', 'Riesgo', 'Falla inminente'];
  const values = [counts.Normal, counts.Riesgo, counts['Falla inminente']];

  if(pieChart) pieChart.destroy();

  pieChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: [
          'rgba(76,175,80,0.9)',
          'rgba(255,193,7,0.9)',
          'rgba(244,67,54,0.9)'
        ],
        borderColor: [
          'rgba(76,175,80,1)',
          'rgba(255,193,7,1)',
          'rgba(244,67,54,1)'
        ],
        borderWidth: 2,
        hoverOffset: 15
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { 
            color: '#cfe8ff',
            font: { size: 12 },
            padding: 20
          }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 36, 0.9)',
          titleColor: '#e6eef6',
          bodyColor: '#cfe8ff'
        }
      },
      cutout: '60%',
      animation: {
        animateScale: true,
        animateRotate: true
      }
    }
  });
}

function buildHistoryChart() {
  const ctx = document.getElementById('historyChart').getContext('2d');
  
  const labels = Array.from({length: historyData.length}, (_, i) => `Ciclo ${i + 1}`);
  
  if(historyChart) historyChart.destroy();

  historyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Riesgo Promedio (%)',
        data: historyData,
        borderColor: '#7c3aed',
        backgroundColor: 'rgba(124, 58, 237, 0.1)',
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#7c3aed',
        pointBorderColor: '#ffffff',
        pointRadius: 4,
        pointHoverRadius: 6,
        borderWidth: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { 
            color: '#cfe8ff',
            font: { size: 12 }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 36, 0.9)',
          titleColor: '#e6eef6',
          bodyColor: '#cfe8ff'
        }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: 'Tiempo (Ciclos de Simulaci√≥n)',
            color: '#cfe8ff',
            font: { size: 12, weight: 'bold' }
          },
          ticks: { 
            color: '#d9f0ff',
            font: { size: 11 }
          },
          grid: { 
            color: 'rgba(255,255,255,0.05)',
            borderColor: 'rgba(255,255,255,0.1)'
          }
        },
        y: {
          title: {
            display: true,
            text: 'Riesgo (%)',
            color: '#cfe8ff',
            font: { size: 12, weight: 'bold' }
          },
          min: 0,
          max: 100,
          ticks: { 
            color: '#d9f0ff',
            font: { size: 11 }
          },
          grid: { 
            color: 'rgba(255,255,255,0.05)',
            borderColor: 'rgba(255,255,255,0.1)'
          }
        }
      },
      interaction: {
        intersect: false,
        mode: 'index'
      }
    }
  });
}

// ========== FUNCIONES DE INTERFAZ ==========
function renderStats(data) {
  const avgTemp = (data.reduce((s, d) => s + d.temp, 0) / data.length).toFixed(1);
  const avgLoad = (data.reduce((s, d) => s + d.load, 0) / data.length).toFixed(1);
  const avgRisk = (data.reduce((s, d) => s + d.risk, 0) / data.length).toFixed(1);
  
  document.getElementById('avg-temp').innerText = `${avgTemp} ¬∞C`;
  document.getElementById('avg-load').innerText = `${avgLoad} %`;
  document.getElementById('avg-risk').innerText = `${avgRisk} %`;
  document.getElementById('renewable-percent').innerText = `${renewablePercentage} %`;
  
  // Actualizar indicadores de sostenibilidad
  document.getElementById('renewable-value').innerText = `${renewablePercentage} %`;
  document.getElementById('emissions-value').innerText = `${emissionsAvoided.toFixed(1)} t CO‚ÇÇ`;
  document.getElementById('efficiency-value').innerText = `${systemEfficiency} %`;
  
  // Actualizar estado del sistema
  updateSystemStatus(avgRisk);
  
  // Actualizar alerta
  updateAlert(avgRisk);
  
  // A√±adir al historial
  historyData.push(parseFloat(avgRisk));
  if (historyData.length > 20) historyData.shift();
  buildHistoryChart();
}

function updateSystemStatus(avgRisk) {
  const statusIndicator = document.getElementById('status-indicator');
  const risk = parseFloat(avgRisk);
  
  if (risk < 60) {
    statusIndicator.className = 'status-indicator green';
    statusIndicator.innerHTML = '<div class="status-dot green"></div><div><strong>ESTADO DEL SISTEMA: ESTABLE</strong></div>';
  } else if (risk < 80) {
    statusIndicator.className = 'status-indicator yellow';
    statusIndicator.innerHTML = '<div class="status-dot yellow"></div><div><strong>ESTADO DEL SISTEMA: RIESGO MODERADO</strong></div>';
  } else {
    statusIndicator.className = 'status-indicator red';
    statusIndicator.innerHTML = '<div class="status-dot red"></div><div><strong>ESTADO DEL SISTEMA: FALLA INMINENTE</strong></div>';
  }
}

function updateAlert(avgRisk) {
  const alertBanner = document.getElementById('alert-banner');
  if (parseFloat(avgRisk) >= 80) {
    alertBanner.classList.add('show');
  } else {
    alertBanner.classList.remove('show');
  }
}

function renderZones() {
  const container = document.getElementById('zones-container');
  container.innerHTML = '';
  
  zones.forEach(zone => {
    const zoneCard = document.createElement('div');
    zoneCard.className = 'zone-card';
    
    // Calcular nivel de riesgo
    let riskLevel = 'green';
    if (zone.failures > 8) riskLevel = 'red';
    else if (zone.failures > 5) riskLevel = 'yellow';
    
    zoneCard.innerHTML = `
      <div class="zone-header">
        <div class="zone-name">${zone.name}</div>
        <div style="color:var(--muted);font-size:13px;">${zone.consumption} MW</div>
      </div>
      <div class="zone-stats">
        <div><i class="fas fa-exclamation-triangle"></i> ${zone.failures} fallos</div>
        <div><i class="fas fa-leaf"></i> ${zone.renewable}% renov.</div>
      </div>
      <div class="zone-bar">
        <div class="zone-bar-fill ${riskLevel}" style="width: ${Math.min(100, zone.consumption)}%"></div>
      </div>
    `;
    
    container.appendChild(zoneCard);
  });
}

function renderTables(data) {
  const tbodyAll = document.querySelector('#table-all tbody');
  tbodyAll.innerHTML = '';
  
  data.forEach(d => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${d.id}</td>
      <td>${d.temp}¬∞C</td>
      <td>${d.load}%</td>
      <td>${d.hours}h</td>
      <td>${d.risk}%</td>
    `;
    tbodyAll.appendChild(tr);
  });

  const tbodyCrit = document.querySelector('#table-critical tbody');
  tbodyCrit.innerHTML = '';
  
  const top5 = [...data].sort((a, b) => b.risk - a.risk).slice(0, 5);
  top5.forEach(d => {
    const tr = document.createElement('tr');
    let tagClass = d.state === 'Normal' ? 'green' : (d.state === 'Riesgo' ? 'yellow' : 'red');
    tr.innerHTML = `
      <td><strong>${d.id}</strong></td>
      <td><strong>${d.risk}%</strong></td>
      <td><span class="tag ${tagClass}">${d.state}</span></td>
    `;
    tbodyCrit.appendChild(tr);
  });
}

function refreshAll() {
  buildScatter(dataset);
  buildPie(dataset);
  renderStats(dataset);
  renderTables(dataset);
  renderZones();
}

// ========== SIMULACI√ìN ==========
function stepSimulation() {
  console.log("üîÑ Ejecutando paso de simulaci√≥n...");
  
  // Modificar transformadores aleatorios
  for(let i = 0; i < Math.max(1, Math.floor(N / 6)); i++) {
    const idx = Math.floor(Math.random() * dataset.length);
    dataset[idx].temp = Math.round(Math.max(30, Math.min(120, dataset[idx].temp + randn(0, 4))) * 10) / 10;
    dataset[idx].load = Math.round(Math.max(20, Math.min(130, dataset[idx].load + randn(0, 6))) * 10) / 10;
    dataset[idx].hours = Math.round(dataset[idx].hours + Math.max(0, Math.floor(randn(40, 40))));
    dataset[idx].risk = Math.min(100, Math.round((0.4 * dataset[idx].temp + 0.4 * dataset[idx].load + 0.2 * (dataset[idx].hours / 100)) * 10) / 10);
    dataset[idx].state = dataset[idx].risk >= 80 ? 'Falla inminente' : (dataset[idx].risk >= 60 ? 'Riesgo' : 'Normal');
  }
  
  // Simular cambios en zonas
  zones.forEach(zone => {
    zone.consumption = Math.max(10, Math.min(80, zone.consumption + randn(0, 3)));
    zone.failures = Math.max(0, Math.min(20, Math.round(zone.failures + randn(0, 0.5))));
    zone.renewable = Math.max(5, Math.min(50, zone.renewable + randn(0, 1)));
  });
  
  // Actualizar sostenibilidad
  renewablePercentage = Math.max(5, Math.min(50, renewablePercentage + randn(0, 0.5)));
  emissionsAvoided += 0.1;
  systemEfficiency = Math.max(70, Math.min(95, systemEfficiency + randn(0, 0.3)));
  
  refreshAll();
}

function startSim() {
  if(simInterval) return;
  simInterval = setInterval(stepSimulation, speed);
  document.getElementById('btn-sim').innerHTML = '<i class="fas fa-pause"></i> Pausar Simulaci√≥n';
  console.log("‚ñ∂Ô∏è Simulaci√≥n iniciada");
}

function stopSim() {
  if(simInterval) {
    clearInterval(simInterval);
    simInterval = null;
  }
  document.getElementById('btn-sim').innerHTML = '<i class="fas fa-play"></i> Iniciar Simulaci√≥n';
  console.log("‚è∏Ô∏è Simulaci√≥n pausada");
}

function toggleSim() {
  if(simInterval) stopSim();
  else startSim();
}

// ========== EVENT LISTENERS ==========
document.addEventListener('DOMContentLoaded', function() {
  console.log("‚úÖ DOM cargado, inicializando SmartGrid Guardian...");
  
  // Generar datos iniciales
  dataset = genData(N);
  
  // Configurar controles deslizantes
  document.getElementById('n-range').addEventListener('input', function(e) {
    N = parseInt(e.target.value);
    document.getElementById('n-span').innerText = N;
    dataset = genData(N);
    refreshAll();
    console.log(`üîß Transformadores ajustados a: ${N}`);
  });
  
  document.getElementById('speed-range').addEventListener('input', function(e) {
    speed = parseInt(e.target.value);
    document.getElementById('speed-span').innerText = speed;
    if(simInterval) {
      stopSim();
      startSim();
    }
    console.log(`‚ö° Velocidad ajustada a: ${speed}ms`);
  });
  
  // Botones de control principales
  document.getElementById('btn-sim').addEventListener('click', toggleSim);
  document.getElementById('btn-step').addEventListener('click', stepSimulation);
  document.getElementById('btn-reset').addEventListener('click', function() {
    stopSim();
    dataset = genData(N);
    historyData = [];
    renewablePercentage = 15;
    emissionsAvoided = 0;
    systemEfficiency = 85;
    refreshAll();
    console.log("üîÑ Sistema reiniciado");
    alert("Sistema reiniciado correctamente");
  });
  
  // Panel del operador
  document.getElementById('btn-reduce-load').addEventListener('click', function() {
    dataset.forEach(d => {
      d.load = Math.max(20, d.load * 0.8);
      d.risk = Math.min(100, Math.round((0.4 * d.temp + 0.4 * d.load + 0.2 * (d.hours / 100)) * 10) / 10);
      d.state = d.risk >= 80 ? 'Falla inminente' : (d.risk >= 60 ? 'Riesgo' : 'Normal');
    });
    refreshAll();
    alert("‚úÖ Carga reducida en todo el sistema el√©ctrico");
    console.log("üìâ Carga reducida manualmente");
  });
  
  document.getElementById('btn-maintenance').addEventListener('click', function() {
    let maintained = 0;
    dataset.forEach(d => {
      if (d.risk >= 60) {
        d.temp = Math.max(30, d.temp * 0.7);
        d.hours = Math.max(500, d.hours * 0.95);
        d.risk = Math.min(100, Math.round((0.4 * d.temp + 0.4 * d.load + 0.2 * (d.hours / 100)) * 10) / 10);
        d.state = d.risk >= 80 ? 'Falla inminente' : (d.risk >= 60 ? 'Riesgo' : 'Normal');
        maintained++;
      }
    });
    refreshAll();
    alert(`üîß Mantenimiento aplicado a ${maintained} transformadores cr√≠ticos`);
    console.log(`üîß Mantenimiento aplicado a ${maintained} transformadores`);
  });
  
  document.getElementById('btn-renewable').addEventListener('click', function() {
    renewablePercentage = Math.min(50, renewablePercentage + 10);
    emissionsAvoided += 5;
    refreshAll();
    alert("üåø Energ√≠a renovable activada - +10% en el sistema");
    console.log("üåø Energ√≠a renovable incrementada");
  });
  
  document.getElementById('btn-redistribute').addEventListener('click', function() {
    const totalLoad = dataset.reduce((sum, d) => sum + d.load, 0);
    const avgLoad = totalLoad / dataset.length;
    
    dataset.forEach(d => {
      d.load = Math.max(20, Math.min(130, avgLoad + randn(0, 5)));
      d.risk = Math.min(100, Math.round((0.4 * d.temp + 0.4 * d.load + 0.2 * (d.hours / 100)) * 10) / 10);
      d.state = d.risk >= 80 ? 'Falla inminente' : (d.risk >= 60 ? 'Riesgo' : 'Normal');
    });
    refreshAll();
    alert("üîÑ Carga redistribuida inteligentemente en el sistema");
    console.log("üîÑ Carga redistribuida en el sistema");
  });
  
  // Inicializar la interfaz
  refreshAll();
  console.log("üéâ SmartGrid Guardian inicializado correctamente para PC");
});

// Inicializaci√≥n final
window.addEventListener('load', function() {
  console.log("üìä P√°gina completamente cargada - Lista para usar");
  // Peque√±o delay para asegurar que todo est√© renderizado
  setTimeout(() => {
    console.log("üöÄ Aplicaci√≥n lista - Puedes iniciar la simulaci√≥n");
  }, 500);
});
</script>
</body>
</html>
